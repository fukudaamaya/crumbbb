

# Connect to Lovable Cloud with User Accounts

## Overview
Set up Lovable Cloud as the backend for Crumb, enabling user sign-up with name and username, profile storage, and migrating bake data from localStorage to a cloud database. This will allow you to track usage and give each user their own bake journal.

## What Users Will Experience
- A sign-up / login screen where they enter their **name**, **email**, **password**, and choose a **username**
- Their bakes are stored in the cloud, accessible from any device
- A profile with their display name and username

## Implementation Steps

### 1. Enable Lovable Cloud
Connect the project to Lovable Cloud to get a database, auth, and edge functions.

### 2. Database Schema
Create the following tables:

**profiles** table -- stores user display info
- `id` (uuid, references auth.users, primary key)
- `display_name` (text, not null)
- `username` (text, unique, not null)
- `created_at` (timestamp)

**bakes** table -- migrates the current localStorage structure to cloud
- `id` (uuid, primary key)
- `user_id` (uuid, references auth.users, not null)
- All existing bake fields: `name`, `date`, `loaf_count`, `loaf_weight_g`, `water_g`, `starter_g`, `leaven_g`, `hydration_pct`, `starter_pct`, `leaven_pct`, `proofing_time_mins`, `bake_temp_c`, `bake_time_mins`, `photo_base64`, `crumb_photo_base64`, `notes`, `rating`, `is_favourite`, `created_at`
- `flours` (jsonb -- array of {type, grams})

**user_roles** table -- for future role-based access
- `id` (uuid, primary key)
- `user_id` (uuid, references auth.users)
- `role` (app_role enum: admin, moderator, user)

### 3. Row-Level Security (RLS)
- **profiles**: Users can read/update only their own profile
- **bakes**: Users can CRUD only their own bakes (filtered by `user_id = auth.uid()`)
- **user_roles**: Read-only via a `has_role()` security definer function

### 4. Database Trigger
Auto-create a profile row when a new user signs up, pulling their name from auth metadata.

### 5. Auth Pages
Create two new pages following the existing Crumb design system (warm brutalist style):

- **Sign Up page** (`/signup`): Fields for display name, username, email, password. Uses `supabase.auth.signUp()` with metadata.
- **Login page** (`/login`): Email and password. Uses `supabase.auth.signInWithPassword()`.
- **Forgot / Reset Password** pages for account recovery.

### 6. Auth Context and Route Protection
- Create an `AuthProvider` context that wraps the app and listens to `onAuthStateChange`
- Redirect unauthenticated users to `/login`
- Redirect authenticated users away from auth pages

### 7. Migrate Data Layer
- Replace the `useBakes` localStorage hook with Supabase queries (using TanStack React Query, already installed)
- `addBake` becomes an `INSERT` into the `bakes` table
- `updateBake` becomes an `UPDATE`
- `deleteBake` becomes a `DELETE`
- List/read queries fetch from Supabase filtered by the current user

### 8. Update Existing Pages
- **Journal**: Fetch bakes from Supabase instead of localStorage
- **BakeDetail**: Read/update/delete via Supabase
- **NewBakeWizard**: Insert new bake via Supabase
- **Dashboard**: Query bakes from Supabase

## Technical Details

### Files to Create
- `src/integrations/supabase/client.ts` -- Supabase client (auto-generated by Cloud)
- `src/contexts/AuthContext.tsx` -- Auth provider with session management
- `src/pages/Login.tsx` -- Login page
- `src/pages/Signup.tsx` -- Sign-up page with name + username
- `src/pages/ResetPassword.tsx` -- Password reset page
- `src/hooks/useBakes.ts` -- Rewrite to use Supabase queries

### Files to Modify
- `src/App.tsx` -- Add AuthProvider, auth routes, and protected route wrapper
- `src/pages/Journal.tsx` -- Minor updates for loading states
- `src/pages/BakeDetail.tsx` -- Use updated hook
- `src/pages/NewBakeWizard.tsx` -- Use updated hook

### Database Migrations
- Migration 1: Create `profiles` table, trigger, and RLS
- Migration 2: Create `bakes` table and RLS
- Migration 3: Create `user_roles` table, enum, `has_role()` function, and RLS
